<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Command Analytics - Sentinel Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="mobile.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .analytics-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .analytics-card h3 {
        margin: 0 0 15px 0;
        color: #667eea;
        font-size: 1.2rem;
      }

      .command-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .command-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
      }

      .command-item:hover {
        background: #f8f9ff;
      }

      .command-name {
        font-weight: 600;
        color: #333;
      }

      .command-stats {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #666;
      }

      .stat-badge {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.85rem;
      }

      .stat-badge.success {
        background: #48bb78;
      }

      .stat-badge.warning {
        background: #ed8936;
      }

      .stat-badge.danger {
        background: #f56565;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filters select,
      .filters input {
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }

      .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .summary-card h4 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
      }

      .summary-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <nav class="sidebar">
        <div class="logo">
          <h2>‚ö° Sentinel</h2>
        </div>
        <ul class="nav-links">
          <li><a href="index.html">üìä Overview</a></li>
          <li><a href="servers.html">üñ•Ô∏è Servers</a></li>
          <li><a href="security.html">üîí Security</a></li>
          <li>
            <a href="command-analytics.html" class="active"
              >üìà Command Analytics</a
            >
          </li>
          <li><a href="admin-links.html">üîó Invite Tracking</a></li>
          <li><a href="../docs/growth.html">üìä Growth Stats</a></li>
        </ul>
      </nav>

      <main class="main-content">
        <header class="content-header">
          <h1>üìà Command Analytics</h1>
          <p>Real-time insights into command usage and performance</p>
        </header>

        <!-- Filters -->
        <div class="filters">
          <select id="timeRange">
            <option value="24h">Last 24 Hours</option>
            <option value="7d" selected>Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="all">All Time</option>
          </select>
          <select id="categoryFilter">
            <option value="all">All Categories</option>
            <option value="moderation">Moderation</option>
            <option value="security">Security</option>
            <option value="utility">Utility</option>
            <option value="fun">Fun</option>
          </select>
          <input
            type="text"
            id="searchCommand"
            placeholder="Search commands..."
          />
        </div>

        <!-- Summary Stats -->
        <div class="summary-stats">
          <div class="summary-card">
            <h4 id="totalCommands">0</h4>
            <p>Total Commands</p>
          </div>
          <div class="summary-card">
            <h4 id="totalExecutions">0</h4>
            <p>Total Executions</p>
          </div>
          <div class="summary-card">
            <h4 id="avgResponseTime">0ms</h4>
            <p>Avg Response Time</p>
          </div>
          <div class="summary-card">
            <h4 id="successRate">0%</h4>
            <p>Success Rate</p>
          </div>
        </div>

        <!-- Analytics Grid -->
        <div class="analytics-grid">
          <!-- Top Commands -->
          <div class="analytics-card">
            <h3>üî• Most Used Commands</h3>
            <div class="command-list" id="topCommands">
              <div style="text-align: center; padding: 40px; color: #999">
                Loading...
              </div>
            </div>
          </div>

          <!-- Slowest Commands -->
          <div class="analytics-card">
            <h3>üêå Slowest Commands</h3>
            <div class="command-list" id="slowCommands">
              <div style="text-align: center; padding: 40px; color: #999">
                Loading...
              </div>
            </div>
          </div>

          <!-- Failed Commands -->
          <div class="analytics-card">
            <h3>‚ùå Commands with Errors</h3>
            <div class="command-list" id="failedCommands">
              <div style="text-align: center; padding: 40px; color: #999">
                Loading...
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="analytics-card" style="margin-bottom: 20px">
          <h3>üìä Usage Trends</h3>
          <div class="chart-container">
            <canvas id="usageChart"></canvas>
          </div>
        </div>

        <div class="analytics-card">
          <h3>‚ö° Performance Distribution</h3>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API_BASE = "https://regular-puma-clearly.ngrok-free.app";

      // Fetch analytics data
      async function fetchAnalytics() {
        try {
          const response = await fetch(
            `${API_BASE}/api/admin/command-analytics`,
            {
              headers: {
                "ngrok-skip-browser-warning": "true",
              },
            }
          );

          if (!response.ok) throw new Error("Failed to fetch analytics");

          const data = await response.json();
          renderAnalytics(data);
        } catch (error) {
          console.error("Error fetching analytics:", error);
          document.getElementById("topCommands").innerHTML =
            '<div style="text-align: center; padding: 40px; color: #f56565;">Failed to load analytics</div>';
        }
      }

      function renderAnalytics(data) {
        // Update summary stats
        document.getElementById("totalCommands").textContent =
          data.totalCommands || 0;
        document.getElementById("totalExecutions").textContent = (
          data.totalExecutions || 0
        ).toLocaleString();
        document.getElementById("avgResponseTime").textContent =
          `${data.avgResponseTime || 0}ms`;
        document.getElementById("successRate").textContent =
          `${data.successRate || 0}%`;

        // Render top commands
        renderCommandList("topCommands", data.topCommands || []);
        renderCommandList("slowCommands", data.slowestCommands || []);
        renderCommandList("failedCommands", data.failedCommands || []);

        // Render charts
        renderUsageChart(data.usageTrends || []);
        renderPerformanceChart(data.performanceDistribution || []);
      }

      function renderCommandList(elementId, commands) {
        const container = document.getElementById(elementId);

        if (commands.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 40px; color: #999;">No data available</div>';
          return;
        }

        container.innerHTML = commands
          .map(
            (cmd) => `
          <div class="command-item">
            <span class="command-name">/${cmd.name}</span>
            <div class="command-stats">
              ${
                cmd.executions
                  ? `<span class="stat-badge">${cmd.executions} uses</span>`
                  : ""
              }
              ${
                cmd.avgTime
                  ? `<span class="stat-badge ${cmd.avgTime > 1000 ? "warning" : "success"}">${cmd.avgTime}ms</span>`
                  : ""
              }
              ${
                cmd.failureRate
                  ? `<span class="stat-badge ${cmd.failureRate > 10 ? "danger" : "warning"}">${cmd.failureRate}% fail</span>`
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      function renderUsageChart(data) {
        const ctx = document.getElementById("usageChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((d) => d.date),
            datasets: [
              {
                label: "Command Executions",
                data: data.map((d) => d.count),
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function renderPerformanceChart(data) {
        const ctx = document
          .getElementById("performanceChart")
          .getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["<100ms", "100-500ms", "500ms-1s", "1s-5s", ">5s"],
            datasets: [
              {
                label: "Commands",
                data: [
                  data.under100 || 0,
                  data.under500 || 0,
                  data.under1000 || 0,
                  data.under5000 || 0,
                  data.over5000 || 0,
                ],
                backgroundColor: [
                  "#48bb78",
                  "#68d391",
                  "#ed8936",
                  "#f56565",
                  "#c53030",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Load data on page load
      fetchAnalytics();

      // Reload every 30 seconds
      setInterval(fetchAnalytics, 30000);
    </script>
  </body>
</html>
