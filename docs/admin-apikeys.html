<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Key Requests - Sentinel Admin</title>
    <script src="admin-auth.js"></script>
    <link
      rel="icon"
      type="image/webp"
      href="https://cdn.discordapp.com/app-icons/1450948411313619199/f3b87982830f72bc256ee6279bde8d03.png?size=256"
    />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="pages.css" />
    <style>
      .admin-nav {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
      }
      .admin-nav a {
        display: inline-block;
        padding: 12px 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        color: white;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
      }
      .admin-nav a:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(-5px);
      }

      .admin-container {
        max-width: 1400px;
        margin: 100px auto;
        padding: 40px;
      }

      .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
      }

      .stat-box h3 {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 10px;
      }

      .stat-box .value {
        font-size: 2.5rem;
        font-weight: 900;
      }

      .stat-box.pending .value {
        color: #ffaa00;
      }

      .stat-box.confirmed .value {
        color: #00ff00;
      }

      .stat-box.declined .value {
        color: #ff4444;
      }

      .stat-box.expired .value {
        color: #888888;
      }

      .logs-table {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        overflow: hidden;
      }

      .logs-table table {
        width: 100%;
        border-collapse: collapse;
      }

      .logs-table th,
      .logs-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .logs-table th {
        background: rgba(255, 255, 255, 0.1);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.85rem;
      }

      .logs-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
      }

      .status-badge.pending {
        background: #ffaa00;
        color: #000;
      }

      .status-badge.confirmed {
        background: #00ff00;
        color: #000;
      }

      .status-badge.declined {
        background: #ff4444;
        color: #fff;
      }

      .status-badge.expired {
        background: #888888;
        color: #fff;
      }

      .user-badge {
        background: #667eea;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .filter-bar {
        margin-bottom: 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .filter-bar input,
      .filter-bar select {
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        flex: 1;
        min-width: 200px;
      }

      .btn-refresh {
        padding: 12px 25px;
        background: #00d1b2;
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 700;
        cursor: pointer;
      }

      .auth-screen {
        max-width: 400px;
        margin: 150px auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 15px;
        text-align: center;
      }

      .auth-screen input {
        width: 100%;
        padding: 15px;
        margin: 20px 0;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
      }

      .auth-screen button {
        width: 100%;
        padding: 15px;
        background: #fff;
        color: #667eea;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }

      .purpose-text {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="admin-nav">
      <a href="admin.html">‚Üê Back to Admin Hub</a>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
      <h1>üîê Admin Login</h1>
      <p>Enter admin password</p>
      <input
        type="password"
        id="password"
        placeholder="Admin password"
        onkeypress="if (event.key === 'Enter') login();"
      />
      <button onclick="login()">Login</button>
      <div id="error" style="color: #ff4444; margin-top: 10px; display: none">
        ‚ùå Invalid password
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none">
      <div class="admin-container">
        <h1 style="font-size: 3rem; margin-bottom: 20px">
          üîë API Key Requests
        </h1>
        <p style="opacity: 0.8; font-size: 1.2rem; margin-bottom: 40px">
          Monitor and track all API key generation requests
        </p>

        <div class="stats-overview">
          <div class="stat-box pending">
            <h3>Pending Requests</h3>
            <div class="value" id="count-pending">0</div>
          </div>
          <div class="stat-box confirmed">
            <h3>Confirmed</h3>
            <div class="value" id="count-confirmed">0</div>
          </div>
          <div class="stat-box declined">
            <h3>Declined</h3>
            <div class="value" id="count-declined">0</div>
          </div>
          <div class="stat-box expired">
            <h3>Expired</h3>
            <div class="value" id="count-expired">0</div>
          </div>
        </div>

        <div class="filter-bar">
          <input
            type="text"
            id="filter-user"
            placeholder="Filter by Discord user..."
            onkeyup="filterRequests()"
          />
          <input
            type="text"
            id="filter-purpose"
            placeholder="Filter by purpose..."
            onkeyup="filterRequests()"
          />
          <select id="filter-status" onchange="filterRequests()">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="declined">Declined</option>
            <option value="expired">Expired</option>
          </select>
          <button class="btn-refresh" onclick="loadRequests()">
            üîÑ Refresh
          </button>
        </div>

        <div class="logs-table">
          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Purpose</th>
                <th>Status</th>
                <th>IP Address</th>
                <th>Created</th>
                <th>Expires</th>
                <th>Processed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requests-body">
              <tr>
                <td colspan="7" style="text-align: center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_API =
        "https://regular-puma-clearly.ngrok-free.app/api/admin/auth";
      const API_KEY_REQUESTS_API =
        "https://regular-puma-clearly.ngrok-free.app/api/admin/apikey-requests";

      let authToken = sessionStorage.getItem("adminToken");
      let allRequests = [];

      if (authToken) {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        loadRequests();
      }

      async function login() {
        const password = document.getElementById("password").value;
        const errorEl = document.getElementById("error");

        try {
          const response = await fetch(ADMIN_API, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "ngrok-skip-browser-warning": "true",
            },
            body: JSON.stringify({ password }),
          });

          if (response.ok) {
            const data = await response.json();
            authToken = data.token;
            sessionStorage.setItem("adminToken", authToken);
            sessionStorage.setItem("adminAuthenticated", "true");
            sessionStorage.setItem(
              "adminTokenExpiry",
              (Date.now() + 30 * 60 * 1000).toString()
            );

            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            loadRequests();
          } else {
            errorEl.textContent = "Invalid password";
            errorEl.style.display = "block";
          }
        } catch (error) {
          errorEl.textContent = "Connection error";
          errorEl.style.display = "block";
        }
      }

      async function loadRequests() {
        try {
          const adminPassword =
            sessionStorage.getItem("adminPassword") ||
            prompt("Enter admin password:");
          if (!adminPassword) return;

          sessionStorage.setItem("adminPassword", adminPassword);

          const response = await fetch(API_KEY_REQUESTS_API + "?limit=100", {
            headers: {
              "x-admin-password": adminPassword,
              "ngrok-skip-browser-warning": "true",
            },
          });

          if (response.ok) {
            const data = await response.json();
            allRequests = data.requests || [];

            // Update counts
            const counts = data.counts || {};
            document.getElementById("count-pending").textContent =
              counts.pending || 0;
            document.getElementById("count-confirmed").textContent =
              counts.confirmed || 0;
            document.getElementById("count-declined").textContent =
              counts.declined || 0;
            document.getElementById("count-expired").textContent =
              counts.expired || 0;

            displayRequests(allRequests);
          } else if (response.status === 401) {
            sessionStorage.removeItem("adminPassword");
            alert("Invalid admin password. Please refresh and try again.");
          }
        } catch (error) {
          console.error("Failed to load requests", error);
        }
      }

      function displayRequests(requests) {
        const tbody = document.getElementById("requests-body");

        if (requests.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" style="text-align: center; opacity: 0.7;">No API key requests yet</td></tr>';
          return;
        }

        tbody.innerHTML = requests
          .map((req) => {
            const created = new Date(req.created_at);
            const expires = req.expires_at ? new Date(req.expires_at) : null;
            const processed = req.confirmed_at
              ? new Date(req.confirmed_at)
              : req.declined_at
                ? new Date(req.declined_at)
                : null;

            const isExpired =
              expires && expires < new Date() && req.status === "pending";

            // Action buttons based on status
            let actionsHTML = "";
            if (req.status === "pending" && !isExpired) {
              actionsHTML = `
                <div style="display: flex; gap: 8px;">
                  <button 
                    onclick="acceptRequest('${req.request_id}')" 
                    style="padding: 6px 12px; background: #00ff00; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;"
                    title="Accept and generate API key"
                  >
                    ‚úÖ Accept
                  </button>
                  <button 
                    onclick="declineRequest('${req.request_id}')" 
                    style="padding: 6px 12px; background: #ff4444; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;"
                    title="Decline this request"
                  >
                    ‚ùå Decline
                  </button>
                </div>
              `;
            } else if (req.status === "confirmed") {
              actionsHTML = `
                <button 
                  onclick="revokeKey('${req.discord_user_id}')" 
                  style="padding: 6px 12px; background: #ff8800; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;"
                  title="Revoke this user's API key"
                >
                  üö´ Revoke
                </button>
              `;
            } else {
              actionsHTML = '<span style="opacity: 0.5;">-</span>';
            }

            return `
        <tr>
          <td>
            <span class="user-badge">${req.discord_username || req.discord_user_id}</span>
            <br>
            <small style="opacity: 0.7; font-size: 0.8rem;">${req.discord_user_id}</small>
          </td>
          <td>
            <div class="purpose-text" title="${req.purpose || "N/A"}">
              ${req.purpose || "N/A"}
            </div>
          </td>
          <td>
            <span class="status-badge ${req.status}">${req.status.toUpperCase()}</span>
            ${isExpired ? '<br><small style="opacity: 0.7;">(Expired)</small>' : ""}
          </td>
          <td><code>${req.ip_address || "N/A"}</code></td>
          <td style="opacity: 0.7; font-size: 0.85rem;">${created.toLocaleString()}</td>
          <td style="opacity: 0.7; font-size: 0.85rem;">${
            expires ? expires.toLocaleString() : "N/A"
          }</td>
          <td style="opacity: 0.7; font-size: 0.85rem;">${
            processed ? processed.toLocaleString() : "-"
          }</td>
          <td>${actionsHTML}</td>
        </tr>
      `;
          })
          .join("");
      }

      function filterRequests() {
        const userFilter = document
          .getElementById("filter-user")
          .value.toLowerCase();
        const purposeFilter = document
          .getElementById("filter-purpose")
          .value.toLowerCase();
        const statusFilter = document.getElementById("filter-status").value;

        const filtered = allRequests.filter((req) => {
          const matchUser =
            !userFilter ||
            (req.discord_username &&
              req.discord_username.toLowerCase().includes(userFilter)) ||
            req.discord_user_id.toLowerCase().includes(userFilter);
          const matchPurpose =
            !purposeFilter ||
            (req.purpose && req.purpose.toLowerCase().includes(purposeFilter));
          const matchStatus = !statusFilter || req.status === statusFilter;

          return matchUser && matchPurpose && matchStatus;
        });

        displayRequests(filtered);
      }

      async function acceptRequest(requestId) {
        if (
          !confirm(
            "Are you sure you want to accept this API key request? An API key will be generated for this user."
          )
        ) {
          return;
        }

        try {
          const adminPassword = sessionStorage.getItem("adminPassword");
          if (!adminPassword) {
            alert("Admin password required. Please refresh and login again.");
            return;
          }

          const response = await fetch(
            `${API_KEY_REQUESTS_API}/${requestId}/accept`,
            {
              method: "POST",
              headers: {
                "x-admin-password": adminPassword,
                "ngrok-skip-browser-warning": "true",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert(
              `‚úÖ API key request accepted!\n\nAPI Key: ${data.apiKey}\n\n‚ö†Ô∏è This key won't be shown again.`
            );
            loadRequests();
          } else {
            alert(`‚ùå Error: ${data.error || "Failed to accept request"}`);
          }
        } catch (error) {
          console.error("Failed to accept request", error);
          alert(`‚ùå Error: ${error.message}`);
        }
      }

      async function declineRequest(requestId) {
        if (
          !confirm("Are you sure you want to decline this API key request?")
        ) {
          return;
        }

        try {
          const adminPassword = sessionStorage.getItem("adminPassword");
          if (!adminPassword) {
            alert("Admin password required. Please refresh and login again.");
            return;
          }

          const response = await fetch(
            `${API_KEY_REQUESTS_API}/${requestId}/decline`,
            {
              method: "POST",
              headers: {
                "x-admin-password": adminPassword,
                "ngrok-skip-browser-warning": "true",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("‚úÖ API key request declined.");
            loadRequests();
          } else {
            alert(`‚ùå Error: ${data.error || "Failed to decline request"}`);
          }
        } catch (error) {
          console.error("Failed to decline request", error);
          alert(`‚ùå Error: ${error.message}`);
        }
      }

      async function revokeKey(userId) {
        if (
          !confirm(
            "Are you sure you want to revoke this user's API key? They will no longer be able to use it."
          )
        ) {
          return;
        }

        try {
          const adminPassword = sessionStorage.getItem("adminPassword");
          if (!adminPassword) {
            alert("Admin password required. Please refresh and login again.");
            return;
          }

          const response = await fetch(
            `https://regular-puma-clearly.ngrok-free.app/api/admin/apikey/${userId}/revoke`,
            {
              method: "POST",
              headers: {
                "x-admin-password": adminPassword,
                "ngrok-skip-browser-warning": "true",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            alert("‚úÖ API key revoked successfully.");
            loadRequests();
          } else {
            alert(`‚ùå Error: ${data.error || "Failed to revoke key"}`);
          }
        } catch (error) {
          console.error("Failed to revoke key", error);
          alert(`‚ùå Error: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
